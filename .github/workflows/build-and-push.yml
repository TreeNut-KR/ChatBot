name: Build and Push Docker Images

on:
  push:
    tags:
      - 'v*'  # 'v'로 시작하는 태그에 대해 작업을 실행합니다.

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TREENUT }}

      - name: Install Node.js and build react-frontpage
        run: |
          cd nginx/react-frontpage
          npm install
          npm run build
        env:
          NODE_VERSION: '14'  # 또는 필요한 Node.js 버전으로 설정

      - name: Create .env files for Docker build
        run: |
          echo "NOTE='첫 프로젝트 파일은 Github에 테스트용 .env를 배포합니다. gitignore에 .env를 등록히얐으니, 추후 .env 업데이트 후 PUSH 되는 일이 없도록 합니다.'" > ./.env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> ./.env
          echo "MYSQL_ROOT_HOST=${{ secrets.MYSQL_ROOT_HOST }}" >> ./.env
          echo "MYSQL_ROOT_USER=${{ secrets.MYSQL_ROOT_USER }}" >> ./.env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> ./.env
          echo "MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}" >> ./.env
          echo "MONGO_ADMIN_USER=${{ secrets.MONGO_ADMIN_USER }}" >> ./.env
          echo "MONGO_ADMIN_PASSWORD=${{ secrets.MONGO_ADMIN_PASSWORD }}" >> ./.env
          echo "MONGO_HOST=${{ secrets.MONGO_HOST }}" >> ./.env

          mkdir -p mongo
          echo "MONGO_ADMIN_USER=${{ secrets.MONGO_ADMIN_USER }}" > ./mongo/.env
          echo "MONGO_ADMIN_PASSWORD=${{ secrets.MONGO_ADMIN_PASSWORD }}" >> ./mongo/.env
          echo "MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}" >> ./mongo/.env
          echo "MONGO_HOST=${{ secrets.MONGO_HOST }}" >> ./mongo/.env
          echo "MONGO_PORT=${{ secrets.MONGO_PORT }}" >> ./mongo/.env

          mkdir -p fastapi/sources
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" > ./fastapi/sources/.env
          echo "MYSQL_ROOT_HOST=${{ secrets.MYSQL_ROOT_HOST }}" >> ./fastapi/sources/.env
          echo "MYSQL_ROOT_USER=${{ secrets.MYSQL_ROOT_USER }}" >> ./fastapi/sources/.env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> ./fastapi/sources/.env
          echo "MONGO_ADMIN_USER=${{ secrets.MONGO_ADMIN_USER }}" >> ./fastapi/sources/.env
          echo "MONGO_ADMIN_PASSWORD=${{ secrets.MONGO_ADMIN_PASSWORD }}" >> ./fastapi/sources/.env
          echo "MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}" >> ./fastapi/sources/.env
          echo "MONGO_HOST=${{ secrets.MONGO_HOST }}" >> ./fastapi/sources/.env
          echo "MONGO_AUTH=admin" >> ./fastapi/sources/.env

      - name: Build and push Nginx image
        uses: docker/build-push-action@v2
        with:
          context: ./nginx
          push: true
          tags: |
            ghcr.io/treenut-kr/nginx:latest
            ghcr.io/treenut-kr/nginx:${{ github.ref_name }}

      - name: Build and push FastAPI image
        uses: docker/build-push-action@v2
        with:
          context: ./fastapi
          push: true
          tags: |
            ghcr.io/treenut-kr/fastapi:latest
            ghcr.io/treenut-kr/fastapi:${{ github.ref_name }}

      - name: Build and push MySQL image
        uses: docker/build-push-action@v2
        with:
          context: ./mysql
          push: true
          tags: |
            ghcr.io/treenut-kr/mysql:latest
            ghcr.io/treenut-kr/mysql:${{ github.ref_name }}

      - name: Build and push MongoDB image
        uses: docker/build-push-action@v2
        with:
          context: ./mongo
          push: true
          tags: |
            ghcr.io/treenut-kr/mongodb:latest
            ghcr.io/treenut-kr/mongodb:${{ github.ref_name }}
